Real-time Unsupervised Anomaly Detection
Group 7: Yi Jen Chen, Cheng Lin Tsai, Shyam Dinesh Patel

Abstract
In this project, we learn a new library called anomalib that is dedicated to unsupervised anomaly detection and localization. With a focus on reproducibility and modularity, this open-source library offers a collection of algorithms from the literature as well as a variety of tools for developing custom anomaly detection algorithms through a plug-and-play approach. The anomaly detection algorithms included in anomalib are among the best-performing models available and can be utilized immediately. Furthermore, the library also includes tools for building custom algorithms that can be customized to meet specific requirements. The library's toolkit includes experiment trackers, visualizers, and hyperparameter optimizers, making it easy to design and implement anomaly detection models. Additionally, the library supports OpenVINO model-optimization and quantization for real-time deployment. Overall, anomalib is a comprehensive library that covers the entire process of developing unsupervised anomaly detection models, from data processing to edge deployment.

1.	Introduction             
The field of machine learning literature is experiencing growth in the area of anomaly detection, which aims to differentiate between normal and anomalous samples in a dataset. Due to a lack of sufficient representative samples in the anomalous class, supervised approaches are generally ineffective for this type of problem. Anomaly detection algorithms address this issue by solely relying on normal samples during the training phase and identifying anomalous samples by comparing them to the learned distribution of normal data. This unsupervised nature of anomaly detection makes it highly suitable for real-world applications, including industrial, medical, and security domains, where a clearly defined anomalous class is often not available.
While there have been various libraries developed for supervised tasks over the past few years, the unsupervised anomaly detection domain has yet to see comparable efforts. Existing anomaly detection libraries typically focus on individual algorithms, lack performance optimizations, or do not incorporate deep learning techniques. Consequently, using these implementations for out-of-the-box comparison of the most recent algorithms on a given dataset can be challenging. To overcome these issues, we present anomalib, a novel library that aims to offer a comprehensive collection of recent deep learning-based anomaly detection techniques and tools.
Anomalib offers a number of advantages by collecting various anomaly detection algorithms and model components into a single library, including:
•	State-of-the-art anomaly detection models that can be utilized to evaluate performance on both public and customized datasets.
•	Modular anomaly model components that enable the development of new algorithms through a plug-and-play approach.
•	Configurable, CLI-based entry points for training, testing, inference, hyperparameter optimization, and benchmarking.
•	Inference interfaces compatible with a variety of exportable model formats that facilitate real-time local or edge deployment.
Overall, anomalib is a comprehensive library that provides a unified set of components and tools suitable for both anomaly detection research and production.
 <img width="468" alt="image" src="https://user-images.githubusercontent.com/95389785/236897643-278ae6f0-048e-40d5-872e-adc6e79b4100.png">

2.	Related work    
Classical approaches to anomaly detection involve creating a concise and enclosed one-class distribution utilizing normal support vectors. Pioneering studies in this area include the one-class support vector machine (OC-SVM) and support vector data description (SVDD). To tackle the challenge of processing high-dimensional data, more recent techniques such as DeepSVDD and PatchSVDD employ deep neural networks to estimate data representations.
An alternative unsupervised approach for anomaly detection involves the use of generative models, such as AutoEncoder (AE) and Generative Adversarial Networks (GAN), for sample reconstruction. These techniques operate on the premise that generative models trained solely on normal samples can effectively reconstruct anomaly-free regions, but struggle with anomalous regions. Nonetheless, recent research suggests that deep models have such a strong generalization ability that even anomalous regions can be well-reconstructed. To address this challenge, reconstruction-based methods have incorporated memory mechanisms, image masking strategies, and pseudo-anomalies. However, these methods still lack the strong discriminative ability required for real-world anomaly detection.

3.	Dataset Description
The MVTec Anomaly Detection dataset consists of 15 categories comprising 3,629 images for training and validation, as well as 1,725 images for testing. The training set exclusively contains images without any defects, while the test set contains both defect-free images and images containing various types of defects. Supplementary material containing further examples of the dataset is also available. The five texture categories include different types of regular (carpet, grid) or random (leather, tile, wood) textures, while the remaining ten categories represent various object types. Some of these objects are rigid with fixed appearances (bottle, metal nut), while others are deformable (cable) or exhibit natural variations (hazelnut). A subset of objects was captured in roughly aligned poses (e.g., toothbrush, capsule, and pill), while others were randomly rotated in front of the camera (e.g., metal nut, screw, and hazelnut). The test images containing anomalous samples comprise a range of defects, such as surface defects on the objects (e.g., scratches, dents), structural defects like distorted object parts, or defects that result in the absence of specific object parts. In total, 73 different types of defects are present, with an average of five per category.
To produce realistic anomalies as they would occur in real-world industrial inspection scenarios, the defects present in the MVTec Anomaly Detection dataset were manually generated. A high-resolution industrial RGB sensor with a resolution of 2048 x 2048 pixels was utilized in combination with two bilateral telecentric lenses with magnification factors of 1:5 and 1:1, respectively. Following image acquisition, the images were cropped to a suitable output size, with resolutions ranging between 700 x 700 and 1024 x 1024 pixels. To accommodate the prevalence of grayscale images in industrial inspection, three object categories (grid, screw, and zipper) were made available solely as single-channel images. The images were acquired under highly controlled illumination conditions, although for some object classes, the illumination was intentionally altered to increase variability. Each defective image region is provided with pixel-precise ground truth labels, with almost 1,900 such regions present in the dataset.

4.	Benchmark
To establish a benchmark for future methods, we conducted a comprehensive evaluation of various cutting-edge unsupervised anomaly detection techniques on our dataset. We also present a clearly defined approach to identifying anomalous regions in test images by estimating hyperparameters exclusively from validation images free of anomalies. We subsequently analyze the merits and limitations of each method as applied to the diverse textures and objects in the dataset. Our findings demonstrate that while each method is capable of detecting certain types of anomalies, none of the assessed techniques demonstrate consistent excellence across the entire dataset.
 <img width="540" alt="image" src="https://user-images.githubusercontent.com/95389785/236897678-762234f1-2f36-4510-99ea-db1f9804485b.png">

5.	Models
5.1.1 PaDiM
The PaDiM algorithm is based on a patch-oriented approach that relies on a pre-trained CNN feature extractor. The input image is partitioned into patches, and embeddings are extracted from each patch using different layers of the feature extractor. The activation vectors from various layers are then concatenated to produce embedding vectors that encompass information from diverse semantic levels and resolutions, facilitating the encoding of both fine-grained and global contexts. However, as the generated embedding vectors may contain redundant information, random selection is used to reduce their dimensions. For each patch of the training image set, a multivariate Gaussian distribution is generated across the entire batch, resulting in a matrix of Gaussian parameters.
During the inference phase, the Mahalanobis distance metric is utilized to score each patch position in the test image. It employs the inverse of the covariance matrix computed during training for the patch. The matrix of Mahalanobis distances serves as the anomaly map, with higher scores indicating anomalous regions.
 <img width="468" alt="image" src="https://user-images.githubusercontent.com/95389785/236897728-a28254cc-4004-4acc-9b1b-13660f8dfc44.png">

5.1.2 PatchCore
The PatchCore algorithm adopts a patch-based approach, where an image can be classified as anomalous if even a single patch is identified as such. The input image is tiled into patches which are then fed into a pre-trained neural network to extract "mid" level features. These features, which capture both local and global contextual information, are then stored in a memory bank of neighbourhood-aware patch-level features during the training phase.
During inference, the memory bank is subsampled using a coreset subsampling technique, which generates a subset that approximates the structure of the available set and reduces the computational cost associated with nearest neighbour search. The anomaly score for each test patch is obtained by calculating the maximum distance between the test patch and its respective nearest neighbour in the subsampled memory bank. This approach allows for efficient and effective detection of anomalous regions in images.
 <img width="468" alt="image" src="https://user-images.githubusercontent.com/95389785/236897769-19dc3faa-775e-4673-babf-10fdf92db185.png">

5.1.3 STFPM
The STFPM algorithm involves a pre-trained teacher network and a student network with the same architecture. The student network learns the distribution of normal (anomaly-free) images by matching its features with corresponding features in the teacher network. To enhance robustness, multi-scale feature matching is utilized, enabling the student network to acquire a mixture of multi-level knowledge from the feature pyramid and thus detect anomalies of different sizes.
 <img width="468" alt="image" src="https://user-images.githubusercontent.com/95389785/236897814-2a9bc35f-f96b-49de-9d19-a67d1ca9e3cf.png">

5.1.4 FastFlow
FastFlow is an unsupervised anomaly detection and localization method that utilizes a two-dimensional normalizing flow-based probability distribution estimator. It can be easily integrated as a module with any deep feature extractor, such as ResNet or Vision Transformer. During the training phase, FastFlow learns to transform the input visual feature into a tractable distribution. During inference, it evaluates the likelihood of identifying anomalies by comparing the distribution of the test images to that of the training images.
 <img width="468" alt="image" src="https://user-images.githubusercontent.com/95389785/236897871-146c4304-ef3d-403e-9d30-624f9a6d4e7e.png">

5.1.5 Reverse Distillation
The Reverse Distillation model consists of three networks: a pre-trained feature extractor (E), a one-class bottleneck embedding (OCBE), and a student decoder network (D). The E network is a ResNet model pre-trained on the ImageNet dataset, and during the forward pass, features from three ResNet blocks are extracted. These features are encoded by concatenating the three feature maps using the multi-scale feature fusion block of the OCBE and passed to the decoder D, which is symmetrical to the feature extractor but reversed.
In the training phase, the outputs from the symmetrical blocks are forced to be similar to the corresponding feature extractor layers by using the cosine distance as the loss metric. During testing, the feature maps' cosine distance is used to indicate the presence of anomalies. The distance maps from all three layers are up-sampled to the image size and combined using addition or multiplication to produce the final feature map. To make the output map smoother, a Gaussian blur is applied. Finally, the anomaly map is generated by applying min-max normalization on the output map. The Reverse Distillation model can be used for unsupervised anomaly detection and localization by assessing the anomaly likelihood.
 <img width="468" alt="image" src="https://user-images.githubusercontent.com/95389785/236897910-97ded93c-c6eb-4212-ab4e-6ed316044be0.png">



5.2 Models Comparison
As you can see below, these five models’ performance aren’t differing too much. Their image size is all 256, except for the “PatchCore” model which includes only 128 images. However, these five models all have the same attributes. To be more specific, the train batch size, test batch size and max epochs are identical. 
  <img width="214" alt="image" src="https://user-images.githubusercontent.com/95389785/236897948-9210479e-9c09-4491-9511-01704895b8ab.png">
<img width="212" alt="image" src="https://user-images.githubusercontent.com/95389785/236897967-e7bea01e-938d-477c-a62e-b2874359104d.png">
<img width="231" alt="image" src="https://user-images.githubusercontent.com/95389785/236897996-4fe0fb35-0aef-4fea-ae23-acc1a40e16ba.png">
<img width="229" alt="image" src="https://user-images.githubusercontent.com/95389785/236898020-05d2e771-f7d6-41d2-b9cf-e0997afe8ab6.png">
<img width="236" alt="image" src="https://user-images.githubusercontent.com/95389785/236898055-66e6fb4b-2b6b-45cd-85ee-e1fa72485354.png">

  
 

6.	Conclusions
We present the MVTec Anomaly Detection dataset, a novel benchmark dataset designed to evaluate unsupervised anomaly detection methods in real-world industrial inspection scenarios. The dataset offers a diverse range of texture and object classes with various types of anomalies, enabling evaluation of anomaly detection methods for both image-level classification and pixel-level segmentation. Accurate pixel-level ground truth labels for anomalous regions are provided, allowing for precise evaluation. The dataset was used to thoroughly evaluate several state-of-the-art methods and two classical methods, resulting in the first comprehensive benchmark on this dataset. The evaluations reveal significant room for improvement and we hope that this dataset will inspire the development of new unsupervised anomaly detection techniques.
